<!DOCTYPE html>
<html lang="en-us">

<head>
  <base href="https://cdn.jsdelivr.net/gh/web-ports/iron-lung@main/">
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>IRON LUNG</title>
<style>
  html,
  body {
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: radial-gradient(circle at center, #120000 0%, #000000 70%);
    font-family: 'Courier New', monospace;
  }

  #unity-canvas {
    width: 100%;
    height: 100%;
    background: #000000;
    display: block;
  }

  /* Horror Loading Text */
  #loading-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 42px;
    color: #8b0000;
    letter-spacing: 4px;
    text-shadow:
      0 0 5px #ff0000,
      0 0 15px #600000,
      0 0 30px #300000;
    animation: flicker 2s infinite, pulse 4s ease-in-out infinite;
    z-index: 10;
  }

  /* Subtle screen grain overlay */
  body::after {
    content: "";
    pointer-events: none;
    position: fixed;
    width: 100%;
    height: 100%;
    background-image: url("https://www.transparenttextures.com/patterns/asfalt-dark.png");
    opacity: 0.08;
    z-index: 5;
  }

  @keyframes flicker {
    0% { opacity: 1; }
    5% { opacity: 0.4; }
    10% { opacity: 1; }
    15% { opacity: 0.2; }
    20% { opacity: 1; }
    100% { opacity: 1; }
  }

  @keyframes pulse {
    0% { text-shadow: 0 0 5px #ff0000; }
    50% { text-shadow: 0 0 25px #ff0000, 0 0 50px #600000; }
    100% { text-shadow: 0 0 5px #ff0000; }
  }
</style>

</head>

<body>
  <div id="loading-text"
    style="color: white; font-size: 48px; font-family: cursive; text-align: center; margin-top: 20px;"> LOADING...
  </div>
  <canvas id="unity-canvas"></canvas>
  <script src="Build/built.loader.js"></script>
  <script>var loadingText = document.querySelector("#loading-text");
    let totalBytes = 0;
    let loadedBytes = 0;

    async function fetchWithProgress(url) {
      const response = await fetch(url);
      const reader = response.body.getReader();
      let chunks = [];
      let received = 0;
      while (true) {
        const {
          done,
          value
        } = await reader.read();
        if (done) break;
        received += value.length;
        loadedBytes += value.length;
        chunks.push(value);
        let mbDone = (loadedBytes / (1024 * 1024)).toFixed(2);
        let mbTotal = '60.7';
        loadingText.textContent = `LOADING... ${mbDone} MB / ${mbTotal} MB`;
      }
      let fullBuffer = new Uint8Array(received);
      let offset = 0;
      for (let chunk of chunks) {
        fullBuffer.set(chunk, offset);
        offset += chunk.length;
      }
      return fullBuffer.buffer;
    }
    async function mergeFiles(fileParts, cacheKey) {
      const buffers = await Promise.all(
        fileParts.map(part => fetchWithProgress(part))
      );
      const mergedBlob = new Blob(buffers);
      return URL.createObjectURL(mergedBlob);
    }

    function getParts(file, start, end) {
      let parts = [];
      for (let i = start; i <= end; i++) {
        parts.push(file + ".part" + i);
      }
      return parts;
    }
    (async () => {
      const [dataUrl, wasmUrl] = await Promise.all([
        mergeFiles(getParts("Build/built.data", 1, 2), "built.data"),
        mergeFiles(getParts("Build/built.wasm", 1, 2), "built.wasm"),
      ]);
      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        var phoneScreenFixer = document.createElement('meta');
        phoneScreenFixer.name = 'viewport';
        phoneScreenFixer.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
        document.getElementsByTagName('head')[0].appendChild(phoneScreenFixer);
      }

      var hugeCanvas = document.querySelector("#unity-canvas");

      createUnityInstance(hugeCanvas, {
        dataUrl: dataUrl,
        frameworkUrl: "Build/built.framework.js",
        codeUrl: wasmUrl,
        streamingAssetsUrl: "StreamingAssets",
        companyName: "98Corbins",
        productName: "Iron Lung",
        productVersion: "1.0",
      });
      loadingText.remove();
    })();
  </script>
</body>

</html>